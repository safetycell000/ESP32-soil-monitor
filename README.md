# 🌱 ESP32 土壌監視システム

## 📋 プロジェクト概要

**目的**: 既存の自動給水システムの効果を監視・分析するためのIoTシステム

このプロジェクトは、**すでに設置されている3時間間隔の自動給水システム**が正常に機能しているかを監視するためのものです。土壌の状態を監視するのではなく、**給水システムの効果を評価**することが主目的です。

## 🎯 システムの目的

### ✅ 正常な状態
- 3時間ごとの給水により土壌水分が上昇
- 時間経過により緩やかに下降
- 全体的に安定した水分レベルを維持

### ⚠️ 問題状態
- **過剰給水**: ベースラインが徐々に上昇し、90%に近づく
- **不足給水**: ベースラインが徐々に下降し、20%に近づく
- **季節要因**: 夏の乾燥、梅雨の過湿による影響

## 🛠️ システム構成

### ハードウェア
```
ESP32-S3 Development Board
├── GPIO9: 静電容量式土壌湿度センサー (DFRobot SEN0193)
├── GPIO2: 手動操作ボタン (校正/臨時計測)
├── WiFi: データ送信用
└── Deep Sleep: 省電力動作
```

### ソフトウェア
```
📁 ESP32-soil-monitor/
├── 🔧 SoilMonitor.ino           # メインプログラム
├── 🔧 WiFi_Setup.ino            # WiFi設定プログラム
├── 🌐 final-dashboard.html      # Webダッシュボード
├── 📊 yearly-data-final.json    # デモデータ（季節変化あり）
├── 🐍 generate_seasonal_demo.py # デモデータ生成スクリプト
└── 📋 README.md                 # このファイル
```

## 🔄 動作フロー

### 1. データ収集
```
ESP32-S3 [30分間隔]
├── Deep Sleep待機
├── ウェイクアップ
├── 土壌湿度測定
├── GitHubウェブフック送信
└── Deep Sleep復帰
```

### 2. データ送信
```
WiFi → GitHub Actions → GitHub Pages
[CORS問題回避のため、直接HTTPリクエストではなくGitHub経由]
```

### 3. データ表示
```
Webダッシュボード
├── 📈 時系列グラフ（基本表示）
├── 🔥 ヒートマップ（年間カレンダー）
├── 📅 期間選択（日/週/月）
└── ◀️ ▶️ ナビゲーション
```

## 📊 データパターンの理解

### 🌡️ 季節による減少速度の変化
- **冬（12-2月）**: 減少遅い（0.5-0.7倍） → 上昇傾向
- **梅雨（6月）**: 減少極遅（0.3-0.4倍） → 大幅上昇
- **夏（7-8月）**: 減少極速（1.8-1.9倍） → 大幅下降
- **春秋**: 普通の減少速度 → 安定

### 📈 正常な給水サイクル
```
時刻: 00:00  03:00  06:00  09:00  12:00  15:00  18:00  21:00
状態:  💧    💧    💧    💧     💧     💧     💧     💧
湿度:  ↑     ↑     ↑     ↑      ↑      ↑      ↑      ↑
     ↓ ↓   ↓ ↓   ↓ ↓   ↓ ↓    ↓ ↓    ↓ ↓    ↓ ↓    ↓ ↓
```

## 🎛️ ダッシュボード機能

### 基本機能
- **期間選択**: 日別/週別/月別表示切り替え
- **ナビゲーション**: ◀️ ▶️ボタンで前後移動
- **グラフ切り替え**: 時系列 ↔ ヒートマップ
- **カレンダー連動**: 選択期間に応じた自動更新

### 表示データ
- **平均湿度**: 選択期間の平均値
- **給水回数**: 期間内の給水実行回数
- **状態判定**: 🟢正常 🟡注意 🟠要注意 🔴危険

## 🚀 セットアップ手順

### 1. ハードウェア準備
```bash
# 必要なもの
- ESP32-S3 開発ボード
- 静電容量式土壌湿度センサー
- ジャンパーワイヤー
- ブレッドボード（オプション）
```

### 2. ソフトウェア設定
```bash
# Arduino IDE設定
1. ESP32 ボードパッケージをインストール
2. WiFi_Setup.ino でWiFi認証情報を設定
3. SoilMonitor.ino でGitHub設定を更新
4. 校正実行（dry_value, wet_value設定）
```

### 3. Webダッシュボード
```bash
# ローカルサーバー起動
cd /path/to/ESP32-soil-monitor
python3 -m http.server 8080

# ブラウザでアクセス
http://localhost:8080/final-dashboard.html
```

## 📝 重要な設定値

### ESP32設定
```cpp
const int SOIL_SENSOR_PIN = 9;           // センサーピン (GPIO9/ADC1_CH8)
const int BUTTON_PIN = 2;                // 操作ボタン (GPIO2)
const int SLEEP_TIME_SECONDS = 1800;     // 30分間隔

// ボタン操作仕様
// 短押し（1秒未満）: 臨時計測・データ送信
// 長押し（1秒以上）: センサーキャリブレーション
```

### 校正値（NVS保存）
```cpp
dry_value: 2800    // 完全乾燥時のADC値 (SEN0193)
wet_value: 1300    // 水中時のADC値 (SEN0193)
```

### GitHub設定
```cpp
const char* GITHUB_USER = "YOUR_USERNAME";
const char* GITHUB_REPO = "ESP32-soil-monitor";
const char* GITHUB_TOKEN = "YOUR_TOKEN";
```

## 🧪 デモデータ

### データ特徴
- **総データ数**: 17,568件（1年間、30分間隔）
- **季節変化**: 減少速度の季節パラメータ化
- **現実的パターン**: 梅雨+33%、夏-57%、冬+20%
- **連続性**: 月間で滑らかな推移

### 生成方法
```bash
python3 generate_seasonal_demo.py
# → yearly-data-final.json が生成される
```

## 🔍 トラブルシューティング

### よくある問題

#### 1. WiFi接続エラー
```
解決策: WiFi_Setup.ino で認証情報を再設定
```

#### 2. センサー値が異常
```
解決策: GPIO2ボタン長押し（1秒以上）で校正実行
```

#### 3. データが送信されない
```
解決策: GitHub Token の権限確認
```

#### 4. ダッシュボードが表示されない
```
解決策: ブラウザのキャッシュクリア（Ctrl+F5）
```

## 📚 技術詳細

### 使用技術
- **MCU**: ESP32-S3 (Dual-core, WiFi, Deep Sleep)
- **センサー**: 静電容量式土壌湿度センサー
- **通信**: WiFi → GitHub API → GitHub Pages
- **フロントエンド**: HTML5, JavaScript, Chart.js
- **データ**: JSON形式、30分間隔

### 特徴的な実装
1. **Deep Sleep**: 30分間隔で省電力動作
2. **NVS保存**: WiFi認証情報と校正値の永続化
3. **CORS回避**: GitHub Actions経由でのデータ送信
4. **季節パラメータ**: 物理的に正確な蒸発率変化
5. **リアルタイム更新**: 選択期間に応じた動的グラフ更新

## 🎯 今後の拡張可能性

### ハードウェア拡張
- 温度・湿度センサー追加
- 複数箇所の土壌監視
- ソーラーパネル電源

### ソフトウェア拡張
- アラート通知機能
- 機械学習による異常検知
- 長期データ分析
- モバイルアプリ化

## 🎯 開発過程で重要視した点

### 1. **物理法則の正確性** ⭐⭐⭐

#### なぜ重要か
このプロジェクトでは「現実的なデモデータ」を作ることが最重要でした。単なる乱数ではなく、**物理的に正しい土壌水分の挙動**を再現する必要がありました。

#### 実装のこだわり
- **給水時**: 必ず水分量が上昇（当然だが重要）
- **時間経過**: 蒸発により必ず減少
- **飽和効果**: 水分量が高いほど給水効果減少
- **蒸発率**: 水分量が高いほど蒸発しやすい

#### 季節パラメータ化
```javascript
// 季節別減少速度（実際のコード例）
const seasonalRates = {
    6: 0.3,   // 梅雨：蒸発極遅（湿気多い）
    7: 1.8,   // 夏：蒸発極速（猛暑乾燥）
    8: 1.9,   // 夏：蒸発最速（猛暑ピーク）
    12: 0.7   // 冬：蒸発遅（湿度保持）
}
```

**結果**: 梅雨+33%上昇、夏-57%下降という**劇的だが現実的**な変化を実現

### 2. **データの連続性** ⭐⭐⭐

#### 問題だった点
- 初期版では月間で急激な数値ジャンプが発生
- 30分間隔なのに時間軸が飛ぶ（00:30 → 03:00）
- ベースライン自体が変わるだけで減少速度変化なし

#### 解決方法
```python
# 連続性を保つ実装例
current_moisture = 70.0  # 初期値から連続
for month in range(1, 13):
    for day in range(1, days_in_month + 1):
        for hour in range(24):  # 24時間すべて
            for minutes in [0, 30]:  # 30分間隔
                # current_moistureを連続的に更新
                current_moisture += watering_effect
                current_moisture -= evaporation_effect
```

**結果**: 滑らかで自然な年間推移、時間軸の完全な連続性

### 3. **検証しやすいデモデータ** ⭐⭐

#### デザイン思想
「現実的でありながら結果が一目で分かる」データを目指しました。

#### 実装の工夫
- **誇張された季節効果**: 通常の2-3倍の変化幅
- **明確な問題パターン**: 過剰→90%接近、不足→20%接近
- **デモ用高速化**: 基本減少率を1.2%/30分に設定

#### 検証ポイント設計
```
梅雨（6月）: 54% → 87% (+33%) ← 一目で過剰と分かる
夏（7月）:   87% → 30% (-57%) ← 一目で不足と分かる
冬（2月）:   66% → 86% (+20%) ← 適度な上昇
```

**結果**: システムの動作検証が容易、デモ効果が高い

### 4. **UI/UXの改善過程** ⭐⭐

#### ナビゲーション機能の重要性
最初はカレンダークリックのみでしたが、「+/-ボタンがほしい」という要望で大幅改善。

#### 実装した機能
- **期間別ナビゲーション**: 日±1、週±7、月±1の自動計算
- **範囲制限**: 2024年外への移動防止
- **ボタン無効化**: 視覚的フィードバック
- **カレンダー連動**: ナビゲーション時の自動更新

#### サイドバー常時表示
「通常開きっぱなしにしてほしい」→ デフォルト表示に変更

#### 機能の整理
「給水効果とアニメーションタブは消して」→ シンプル化優先

**結果**: 直感的で使いやすいインターフェース

### 5. **真の目的の明確化** ⭐

#### 重要な認識
- ❌ 土壌の状態監視システム
- ✅ **既存給水システムの効果監視システム**

#### 着目点の違い
- **一般的な土壌監視**: 絶対湿度値が重要
- **このシステム**: **ベースライン変化の傾向**が重要

#### 判定基準
```
正常: 給水効果 ≈ 蒸発量 → 安定したベースライン
過剰: 給水効果 > 蒸発量 → ベースライン上昇傾向
不足: 給水効果 < 蒸発量 → ベースライン下降傾向
```

**結果**: 明確な目的意識によるシステム設計

## 💡 開発の教訓

### データ生成における学び
1. **物理法則の重要性**: 現実的なデモには正確な物理モデルが必須
2. **連続性の価値**: データの滑らかさが信頼性を大きく左右
3. **検証容易性**: 誇張された変化でも現実的であれば効果的

### UI設計における学び
1. **ユーザー要望の即応**: +/-ボタンなど直感的操作の重要性
2. **シンプル化の価値**: 不要機能削除による使いやすさ向上
3. **常時表示の効果**: アクセシビリティ向上

### システム設計における学び
1. **目的の明確化**: 何を監視するかの定義が最重要
2. **現実的なデモ**: 理論と実用のバランス
3. **段階的改善**: ユーザーフィードバックによる継続改善

---

## 📞 サポート

質問や問題がある場合は、このREADMEを参照してシステムの動作を確認してください。

**最終更新**: 2024年12月
**プロジェクト状態**: ✅ 完成・動作確認済み